<!DOCTYPE html>
<html>
<head>
    <title>Virtue / Vice</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../css/list.css">
    <script src='../js/global.js'></script>
</head>
<body onload="checkCurrentUser();">
    <input type="button" onclick="logOut();" value="Log Out"></input>
    <section>
        <h1>Habit List</h1>
        <ul id="habit-list"></ul>
    </section>
    <button type="button" id="addHabit" onclick="location.href='add.html'" title="add habit">+</button>
    <script type="text/javascript">
        populateList();

        function showMsg(element){
            var msgElement = (element.parentNode.parentNode.getElementsByClassName("message"))[0];
            msgElement.style.visibility="visible";
        }

        // Go to edit page
        function editHabit(id) {
            var user = getCurrentUser();
            user.editID = id;
            modifyCurrentUser(user);
            window.location = 'edit.html';
        }

        // Removes habit entry from the list and from local storage
        function deleteHabit(element, id){
            // Remove from user's habit list
            var user = getCurrentUser();
            var removeList = JSON.parse(user.list);
            for(h in removeList) {
                if(removeList[h].id == id) {
                    removeList.splice(h, 1);
                    break;
                }
            }

            // Store newly modified list into the user's account
            user.list = JSON.stringify(removeList);
            modifyCurrentUser(user);

            // Remove habit entry from document
            var child = element.parentNode.parentNode;
            var parent = child.parentNode;
            parent.removeChild(child);
        }

        // Dynamically adds habits into the document habit list
        function populateList() {
            // Create template habit object
            var habit = {
                id: "",
                title : "",
                icon : "../img/no.jpg",
                weekly_freq : [],
                daily_freq : 1,
                notes : ""
            };

            // Grab containing element for which we are going to add items into
            var container = document.getElementById('habit-list');

            // Obtain habits from current user
            var user = getCurrentUser();
            var habitList = JSON.parse(user.list);

            // Iterate through habits in local storage, modify temporary habit object,
            // and add list entry into the document using the habit object's data
            for(h in habitList) {
                habit.id = habitList[h].id;
                habit.title = habitList[h].title;
                habit.icon = habitList[h].icon;

                var outerList = document.createElement('li');
                outerList.setAttribute("id", "habitItem_"+habit.id);
                outerList.innerHTML = formatTemplate(habit);

                container.appendChild(outerList);
            }
        }

        // Returns a formateted string template for a list entry
        function formatTemplate(habit)
        {
            return "\n"+
                "<ul class='habit-info'>\n"+
                "\t<li><div class='habit-name'>"+habit.title+"</div></li>\n"+
                "\t\t<li><img class='habit-icon' src='"+habit.icon+"' alt='habit icon'></li>\n"+
                "</ul>\n"+
                "<div class='message'>\n"+
                "\t<span class='message-total'>\n"+
                "\t\t<strong>48</strong> days in a row! Best Record: <strong>60</strong><br>\n"+
                "\t\t\t<svg height='25' width='150'>\n"+
                "\t\t\t\t<line x1='0' y1='0' x2='120' y2='0' style='stroke:rgba(65, 131, 215, 0.8);stroke-width:25' />\n"+
                "\t\t\t\t<line x1='120' y1='0' x2='150' y2='0' style='stroke:rgba(171,171,171,0.6);stroke-width:25' />\n"+
                "\t\t\t</svg>\n"+
                "\t</span><br>\n"+
                "\t<span class='message-today'>Completed <strong>1/2</strong> for today!</span>\n"+
                "</div>\n"+
                "<div class='habit-op'>\n"+
                "\t<button type='button' class='op op-done' onclick='showMsg(this);' title='done'>\n"+
                "\t\t<img src='../img/done.svg' alt='Done'>\n"+
                "\t</button>\n"+
                "\t<button type='button' class='op op-edit' onclick='editHabit("+habit.id+");' title='edit habit'>\n"+
                "\t\t<img src='../img/edit.svg' alt='Edit'>\n"+
                "\t</button>\n"+
                "\t<button type='button' class='op op-del' onclick='deleteHabit(this, "+habit.id+");' title='delete habit'>\n"+
                "\t\t<img src='../img/delete.svg' alt='Del'>\n"+
                "\t</button>\n"+
                "</div>\n";
        }
    </script>
</body>
</html>