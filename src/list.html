<!DOCTYPE html>
<html>
<head>
    <title>Virtue / Vice</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../css/list.css">
	<script src='https://cdn.firebase.com/js/client/2.3.1/firebase.js'></script>
    <script src='../js/global.js'></script>
</head>
<body onload="checkCurrentUser();">
    <input type="button" onclick="logOut();" value="Log Out"></input>
    <section>
        <h1>Habit List</h1>
        <ul id="habit-list"></ul>
    </section>
    <button type="button" id="addHabit" onclick="location.href='add.html'" title="add habit">+</button>
    <script type="text/javascript">
		
        populateList();

        // Returns a formateted string template for a list entry
        function formatTemplate(habit)
        {
            var listString = '\n'+
            '<ul class="habit-info">'+
            '    <li>'+
            '        <div class="habit-name">'+habit.title+'</div>'+
            '        <button id="options-button" type="button" class="op op-gear" onClick="toggleButton(this);" title="habit options">'+
            '            <img id="gear" class="gear-img" src="../img/gear.png" alt="Edit">'+
            '        </button>'+
            '        <div class="white-square"></div>'+
            '        <span id="options-slideout" class="options">'+
            '            <button type="button" class="op op-edit" onclick="editHabit('+habit.id+');" title="edit habit">'+
            '                <img class="small-buttons" src="../img/edit.svg" alt="Edit">'+
            '            </button>'+
            '            <button type="button" class="op op-del" onclick="deleteHabit(this, '+habit.id+');" title="delete habit">'+
            '                <img class="small-buttons" src="../img/delete.svg" alt="Del">'+
            '            </button>'+
            '        </span>'+
            '    </li>'+
            '    <li><img class="habit-icon" src="'+habit.icon+'" alt="habit icon"></li>'+
            '</ul>'+
            '<div class="message">'+
            '    <span class="message-total">'+
            '        <strong>2</strong> days in a row! Best Record: <strong>5</strong><br>'+
            '        <svg height="25" width="150">'+
            '            <line x1="0" y1="0" x2="60" y2="0" style="stroke:rgba(65, 131, 215, 0.8);stroke-width:25" />'+
            '            <line x1="60" y1="0" x2="150" y2="0" style="stroke:rgba(171,171,171,0.6);stroke-width:25" />'+
            '        </svg>'+
            '    </span><br>'+
            '    <span class="message-today">Completed <strong>1/1</strong> for today!</span>'+
            '</div>'+
            '<div class="habit-op">'+
            '    <button type="button" class="op op-done" onclick="showMsg(this);" title="done">'+
            '        <img src="../img/done.svg" alt="Done">'+
            '    </button>'+
            '    <button type="button" class="op op-fail" onclick="showMsg(this);" title="done">'+
            '        <img src="../img/xIcon.png" alt="Done">'+
            '    </button>'+
            '</div>';
            return listString;
        }

        function showMsg(element){
            var msgElement = (element.parentNode.parentNode.getElementsByClassName("message"))[0];
            msgElement.style.visibility="visible";
        }

        // Go to edit page
        function editHabit(id) {
            var user = getCurrentUser();
            user.editID = id;
            modifyCurrentUser(user);
            window.location = 'edit.html';
        }

        // Removes habit entry from the list and from local storage
        function deleteHabit(element, id){
            // Remove from user's habit list
            var user = getCurrentUser();
            var removeList = JSON.parse(user.list);
            for(h in removeList) {
                if(removeList[h].id == id) {
                    removeList.splice(h, 1);
                    break;
                }
            }

            // Store newly modified list into the user's account
            user.list = JSON.stringify(removeList);
            modifyCurrentUser(user);

            // Remove habit entry from document
            var child = getHabitRoot(element);
            var parent = child.parentNode;
            parent.removeChild(child);
        }

        // Dynamically adds habits into the document habit list
        function populateList() {
            // Create template habit object
            var habit = {
                id: "",
                title : "",
                icon : "../img/no.jpg",
                weekly_freq : [],
                daily_freq : 1,
                notes : ""
            };

            // Grab containing element for which we are going to add items into
            var container = document.getElementById('habit-list');

            // Obtain habits from current user
            var user = getCurrentUser();
            var habitList = JSON.parse(user.list);

            // Iterate through habits in local storage, modify temporary habit object,
            // and add list entry into the document using the habit object's data
            for(h in habitList) {
                habit.id = habitList[h].id;
                habit.title = habitList[h].title;
                habit.icon = habitList[h].icon;

                var outerList = document.createElement('li');
                outerList.setAttribute("id", "habitItem_"+habit.id);
                outerList.innerHTML = formatTemplate(habit);

                container.appendChild(outerList);
            }
        }

        /*** Animation ***/

        /* slides out the options then back in */
        function toggleButton(element) {
            var parent = element.parentNode;
            var optionsButton = findChild(parent, "options-button");
            var optionsMenu = findChild(parent, "options-slideout");
            if (optionsMenu.className == "options") {
                // toggle in options
                optionsMenu.className = "options-out";
                optionsButton.className = "op op-gear selected";
            } else {
                // toggle out options
                optionsMenu.className = "options";
                optionsButton.className = "op op-gear";
            }
        }


        /*** Helper functions ***/

        /* returns the habit list node corresponding to an element in the habit */
        function getHabitRoot(element) {
            var curNode = element;
            while (curNode.parentNode.id != "habit-list") {
                curNode = curNode.parentNode;
            }
            return curNode;
        }

        /* finds a child by id of a parent node */
        function findChild(parent, id) {
            var children = parent.childNodes;
            var result;
            var node;
            for (node in children) {
                if (children[node].id == id) {
                    result = children[node];
                }
            }
            return result;
        }

    </script>
</body>
</html>