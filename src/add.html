<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Add Habit</title>
		<link rel="stylesheet" href="../css/forms.css">
		<script src='https://cdn.firebase.com/js/client/2.3.1/firebase.js'></script>
		<script src='../js/global.js'></script>
	</head>
	<body onload="checkCurrentUser();">
    	<input type="button" onclick="logOut();" value="Log Out"></input>
		<div class="forms">
			<h2>Add A Habit</h2>
			<form>
				<p><label><span id="title_text">Habit Title</span></label></p>
				<p><input id="habit_title" type="text" name="fullname" placeholder="Exercise 30 minutes"></p>
				<p><label>Habit Icon</label></p>
				<div id="habit_icons">
					<img id="../img/sleep.jpgID" class="icon" onclick="selectImage(this);" src="../img/sleep.jpg" alt="sleep image"/>
					<img id="../img/salad.jpgID" class="icon" onclick="selectImage(this);" src="../img/salad.jpg" alt="eat image"/>
					<img id="../img/run.jpgID" class="icon" onclick="selectImage(this);" src="../img/run.jpg" alt="run image"/>
					<img id="../img/add.pngID" class="icon" src="../img/add.png" alt="find a image"/>
				</div>
				<p><label>Weekly Frequency (optional)</label></p>
				<div id="ck-button">
					<label> <input id="SundayID" type="checkbox" name="date" value="Sunday" checked><span>Sun</span></label>
					<label> <input id="MondayID" type="checkbox" name="date" value="Monday" checked><span>Mon</span></label>
					<label> <input id="TuesdayID" type="checkbox" name="date" value="Tuesday" checked><span>Tues</span></label>
					<label> <input id="WednesdayID" type="checkbox" name="date" value="Wednesday" checked><span>Wed</span></label>
					<label> <input id="ThursdayID" type="checkbox" name="date" value="Thursday" checked><span>Thur</span></label>
					<label> <input id="FridayID" type="checkbox" name="date" value="Friday" checked><span>Fri</span></label>
					<label> <input id="SaturdayID" type="checkbox" name="date" value="Saturday" checked><span>Sat</span></label>
				</div>

				<p><label>Daily Frequency</label></p>
				<div id="daily-button">
					<label> <input id="Day1ID" type="radio" name="day" value="1" checked><span>1</span></label>
					<label> <input id="Day2ID" type="radio" name="day" value="2"><span>2</span></label>
					<label> <input id="Day3ID" type="radio" name="day" value="3"><span>3</span></label>
					<span id="times">times</span>
				</div>
				<p><label><span id="notes_text">Notes (optional): </span></label></p>
				<p><input id="notes" type="text" name="day" placeholder="None"></p>
				<p id="save_p"><input id="save" type="button" value="Save It" onclick="onSubmit();"></p>
			</form>
		</div>
		<script>
			/**
			 * habit object which is filled and submitted after the form
			 * passes validation.
			 *
			 * Required fields: habit_title
			 * Optional fields: icon, weekly_freq, daily_freq, notes
			 */
			var newHabit = {
				id : "",
				title : "",
				icon : "",
				weekly_freq : [],
				daily_freq : 1,
				notes : "",
				completed_days: 0,
                total_days : 1,
                current_streak: 0,
                longest_streak: 0,
                completed_today: 0
			};

			selectImage(document.getElementById("../img/sleep.jpgID"));

			function onSubmit() {
				// If form validates, submit habit
				if (validateForm()) {

					// Populate the habit object
					newHabit.title = document.getElementById('habit_title').value;
					newHabit.weekly_freq = getWeeklyFrequency();
					newHabit.daily_freq = getDailyFrequency();
					newHabit.notes = document.getElementById('notes').value;
					var user = getCurrentUser();
					var newList = [];

					// Check if habit list exists already,
					// if list does not exist, create a new list with new habit
					if(user.list == 'null') {

						//  Set the habit item's ID
						user.nextHabitID = '1';
						newHabit.id = '0';
						newList[0] = newHabit;
					}
					// if list exists, add habit to list
					else {
						newList = JSON.parse(user.list);

						// if list exists, check if it is empty
						// if empty, reset nextID counter, and add new habit
						if(newList.length == 0) {
							// Set the habit item's ID
							user.nextHabitID = '1';
							newHabit.id = '0';
							newList[0] = newHabit;
						}
						// if not empty, continue adding habit item as normal
						else {

							// Set the habit item's ID
							newHabit.id = user.nextHabitID;
							user.nextHabitID = parseInt(user.nextHabitID)+1;
							newList.push(newHabit);
						}
					}

					// Store newly modified list into user's account
					user.list = JSON.stringify(newList);
					modifyCurrentUser(user);

					// navigate to list page
					window.location = 'list.html';
				} else {
					alert('form failed validation');
					// do nothing
				}
			}

			/**
			 * Validates the current habit object to see if the form can be submitted
			 * returns true if the form validates, false if it doesn't.
			 */
			function validateForm() {
				// Check if the user entered a title.
				if (document.getElementById('habit_title').value == "") {
					// TODO: add markup to display validation message (unhide it or w/e)
					console.log("need a title");
					return false;
				}

				// passed validation checks, return true.
				return true;
			}

			/**
			 * Returns an array with all of the currently selected weeks for weekly
			 * frequency.
			 */
			function getWeeklyFrequency() {
				var labels = document.getElementById("ck-button").children;
				var selected_weeks = [];
				var week;
				// Push each selected week into the selected_weeks array.
				for (var i = 0; i < labels.length; i++) {
					week = labels[i].children.date;
					if (week.checked) {
						console.log(i);
						selected_weeks.push(true);
					} else {
						selected_weeks.push(false);
					}
				}
				if(selected_weeks.length == 0) {
					// TODO: throw validation instead
					for (var i = 0; i < labels.length; i++) {
						week = labels[i].children.date;
						// selected_weeks.push(week.value);
						selected_weeks.push(true);
					}
				}
				return selected_weeks;
			}

			/**
			 * Returns the selected daily frequency.
			 */
			function getDailyFrequency() {
				var labels = document.getElementById("daily-button").children;
				var selected_freq;
				for (var i = 0; i < labels.length; i++) {
					selected_freq = labels[i].children.day;
					if (selected_freq.checked) {
						return selected_freq.value;
					}
				}

				// return 0 if everything became unselected somehow
				return 0;
			}

			/**
			 * Sets the habit object's current icon to the selected image.
			 * Changes the border of the image to show it's selected.
			 */
			function selectImage(el) {
				var habit_icons = document.getElementById("habit_icons").children;
				// Clear the effects on the other images
				for (var i = 0; i < habit_icons.length; i++) {
					habit_icons[i].style.border = "none";
				}

				el.style.border = "5px solid #42A5F5";

				// Save the current image into the habit object.
				newHabit.icon = el.src;
			}
		</script>
	</body>
</html>
